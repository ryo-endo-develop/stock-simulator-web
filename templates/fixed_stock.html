{% extends "base.html" %}

{% block title %}å›ºå®šéŠ˜æŸ„åˆ†æ - LLMæŠ•è³‡ã‚¢ã‚¤ãƒ‡ã‚¢æ¤œè¨¼ãƒ„ãƒ¼ãƒ«{% endblock %}

{% block content %}
<h1 class="mb-4">ğŸ“Š å›ºå®šéŠ˜æŸ„ã§ã®LLMäºˆæ¸¬ç²¾åº¦æ¤œè¨¼</h1>
<p class="text-muted mb-4">åŒä¸€éŠ˜æŸ„ã«å¯¾ã™ã‚‹è¤‡æ•°LLMã®äºˆæ¸¬ç²¾åº¦ã‚’æ¯”è¼ƒåˆ†æã—ã¾ã™ã€‚</p>

{% if success_message %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="fas fa-check-circle me-2"></i>{{ success_message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

{% if error_message %}
<div class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="fas fa-exclamation-circle me-2"></i>{{ error_message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

{% if result %}
<!-- çµæœè¡¨ç¤º -->
<div class="card mb-4">
    <div class="card-header bg-success text-white">
        <h5 class="mb-0"><i class="fas fa-check-circle me-2"></i>ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†ï¼</h5>
    </div>
    <div class="card-body">
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">ğŸ’° ç·æç›Š</h5>
                        <h3 class="{% if result.profit_loss > 0 %}text-success{% else %}text-danger{% endif %}">
                            Â¥{{ "{:,.2f}".format(result.profit_loss) }}
                        </h3>
                        <small class="text-muted">{{ "{:+.2f}".format(result.return_rate) }}%</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">ğŸ“Š é¨°è½ç‡</h5>
                        <h3 class="{% if result.return_rate > 0 %}text-success{% else %}text-danger{% endif %}">
                            {{ "{:+.2f}".format(result.return_rate) }}%
                        </h3>
                        <small class="text-muted">{% if result.return_rate > 0 %}åˆ©ç›Š{% else %}æå¤±{% endif %}</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">ğŸ¯ ç·åˆã‚¹ã‚³ã‚¢</h5>
                        <h3 class="{% if result.overall_score > 80 %}text-success{% elif result.overall_score > 60 %}text-warning{% else %}text-danger{% endif %}">
                            {{ "{:.1f}".format(result.overall_score) }}%
                        </h3>
                        <small class="text-muted">{% if result.overall_score > 80 %}é«˜ç²¾åº¦{% else %}è¦æ”¹å–„{% endif %}</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">ğŸ“… ä¿æœ‰æœŸé–“</h5>
                        <h3 class="text-info">{{ result.period_days }}æ—¥</h3>
                        <small class="text-muted">è¨­å®šæœŸé–“</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- è©³ç´°æƒ…å ± -->
        <div class="row mb-4">
            <div class="col-md-4">
                <h6>ğŸ“ˆ å®Ÿéš›ã®æ ªä¾¡æƒ…å ±</h6>
                <ul class="list-unstyled">
                    <li><strong>è³¼å…¥ä¾¡æ ¼:</strong> Â¥{{ "{:,.0f}".format(result.buy_price) }}</li>
                    <li><strong>å£²å´ä¾¡æ ¼:</strong> Â¥{{ "{:,.0f}".format(result.sell_price) }}</li>
                    <li><strong>æœŸé–“æœ€é«˜å€¤:</strong> Â¥{{ "{:,.0f}".format(result.actual_high) }}</li>
                    <li><strong>æœŸé–“æœ€å®‰å€¤:</strong> Â¥{{ "{:,.0f}".format(result.actual_low) }}</li>
                </ul>
            </div>
            <div class="col-md-4">
                <h6>ğŸ”® LLMäºˆæ¸¬å€¤</h6>
                <ul class="list-unstyled">
                    <li><strong>äºˆæƒ³æœ€é«˜å€¤:</strong> Â¥{{ "{:,.0f}".format(result.predicted_high) }}</li>
                    <li><strong>äºˆæƒ³æœ€å®‰å€¤:</strong> Â¥{{ "{:,.0f}".format(result.predicted_low) }}</li>
                    <li><strong>é€±æœ«çµ‚å€¤äºˆæƒ³:</strong> Â¥{{ "{:,.0f}".format(result.predicted_close) }}</li>
                    <li><strong>æœŸé–“:</strong> {{ result.period_days }}æ—¥é–“</li>
                </ul>
            </div>
            <div class="col-md-4">
                <h6>ğŸ¯ äºˆæ¸¬ç²¾åº¦ã®è©³ç´°</h6>
                <ul class="list-unstyled">
                    <li><strong>çµ‚å€¤ç²¾åº¦:</strong> <span class="{% if result.close_accuracy > 80 %}text-success{% elif result.close_accuracy > 60 %}text-warning{% else %}text-danger{% endif %}">{{ "{:.1f}".format(result.close_accuracy) }}%</span></li>
                    <li><strong>æœ€é«˜å€¤ç²¾åº¦:</strong> <span class="{% if result.high_accuracy > 80 %}text-success{% elif result.high_accuracy > 60 %}text-warning{% else %}text-danger{% endif %}">{{ "{:.1f}".format(result.high_accuracy) }}%</span></li>
                    <li><strong>æœ€å®‰å€¤ç²¾åº¦:</strong> <span class="{% if result.low_accuracy > 80 %}text-success{% elif result.low_accuracy > 60 %}text-warning{% else %}text-danger{% endif %}">{{ "{:.1f}".format(result.low_accuracy) }}%</span></li>
                    <li><strong>ç·åˆã‚¹ã‚³ã‚¢:</strong> <span class="{% if result.overall_score > 80 %}text-success{% elif result.overall_score > 60 %}text-warning{% else %}text-danger{% endif %}">{{ "{:.1f}".format(result.overall_score) }}%</span></li>
                </ul>
            </div>
        </div>
        
        <!-- è¦–è¦šçš„ãªç²¾åº¦æ¯”è¼ƒ -->
        <div class="row mb-4">
            <div class="col-12">
                <h6>ğŸ“Š äºˆæ¸¬ç²¾åº¦ã®è¦–è¦šçš„æ¯”è¼ƒ</h6>
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label">çµ‚å€¤ç²¾åº¦</label>
                        <div class="progress mb-2">
                            <div class="progress-bar {% if result.close_accuracy > 80 %}bg-success{% elif result.close_accuracy > 60 %}bg-warning{% else %}bg-danger{% endif %}" 
                                 style="width: {{ result.close_accuracy }}%">{{ "{:.1f}".format(result.close_accuracy) }}%</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">æœ€é«˜å€¤ç²¾åº¦</label>
                        <div class="progress mb-2">
                            <div class="progress-bar {% if result.high_accuracy > 80 %}bg-success{% elif result.high_accuracy > 60 %}bg-warning{% else %}bg-danger{% endif %}" 
                                 style="width: {{ result.high_accuracy }}%">{{ "{:.1f}".format(result.high_accuracy) }}%</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">æœ€å®‰å€¤ç²¾åº¦</label>
                        <div class="progress mb-2">
                            <div class="progress-bar {% if result.low_accuracy > 80 %}bg-success{% elif result.low_accuracy > 60 %}bg-warning{% else %}bg-danger{% endif %}" 
                                 style="width: {{ result.low_accuracy }}%">{{ "{:.1f}".format(result.low_accuracy) }}%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¿å­˜ãƒ•ã‚©ãƒ¼ãƒ  -->
        <form method="post" action="/fixed-stock/save" class="mt-4">
            <input type="hidden" name="model_id" value="{{ result.model_id }}">
            <input type="hidden" name="stock_code" value="{{ result.stock_code }}">
            <input type="hidden" name="buy_date" value="{{ result.actual_buy_date }}">
            <input type="hidden" name="buy_price" value="{{ result.buy_price }}">
            <input type="hidden" name="sell_date" value="{{ result.actual_sell_date }}">
            <input type="hidden" name="sell_price" value="{{ result.sell_price }}">
            
            <!-- 3ã¤ã®äºˆæ¸¬å€¤ -->
            <input type="hidden" name="predicted_high" value="{{ result.predicted_high }}">
            <input type="hidden" name="predicted_low" value="{{ result.predicted_low }}">
            <input type="hidden" name="predicted_close" value="{{ result.predicted_close }}">
            <input type="hidden" name="predicted_price" value="{{ result.predicted_price }}">
            
            <!-- 3ã¤ã®å®Ÿéš›å€¤ -->
            <input type="hidden" name="actual_high" value="{{ result.actual_high }}">
            <input type="hidden" name="actual_low" value="{{ result.actual_low }}">
            
            <!-- çµæœ -->
            <input type="hidden" name="profit_loss" value="{{ result.profit_loss }}">
            <input type="hidden" name="return_rate" value="{{ result.return_rate }}">
            
            <!-- ç²¾åº¦æŒ‡æ¨™ -->
            <input type="hidden" name="prediction_accuracy" value="{{ result.close_accuracy }}">
            <input type="hidden" name="close_accuracy" value="{{ result.close_accuracy }}">
            <input type="hidden" name="high_accuracy" value="{{ result.high_accuracy }}">
            <input type="hidden" name="low_accuracy" value="{{ result.low_accuracy }}">
            <input type="hidden" name="overall_score" value="{{ result.overall_score }}">
            
            <input type="hidden" name="period_days" value="{{ result.period_days }}">
            <input type="hidden" name="notes" value="{{ result.notes }}">
            
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="fas fa-save me-2"></i>çµæœã‚’ä¿å­˜
            </button>
        </form>
    </div>
</div>
{% endif %}

<!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-edit me-2"></i>å›ºå®šéŠ˜æŸ„åˆ†æãƒ•ã‚©ãƒ¼ãƒ </h5>
    </div>
    <div class="card-body">
        <form method="post" action="/fixed-stock">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="model_id" class="form-label">ğŸ¤– LLMãƒ¢ãƒ‡ãƒ«å</label>
                        <select class="form-select" id="model_id" name="model_id" required>
                            <option value="">ãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                            {% for model in ai_models %}
                            <option value="{{ model.model_code }}" title="{{ model.description }}">{{ model.display_name }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">åˆ†æã™ã‚‹LLMãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
                    </div>

                    <div class="mb-3">
                        <label for="stock_code" class="form-label">ğŸ“ˆ éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰</label>
                        <input type="text" class="form-control" id="stock_code" name="stock_code" 
                               placeholder="ä¾‹: 7203 (ãƒˆãƒ¨ã‚¿), 6758 (ã‚½ãƒ‹ãƒ¼)" required>
                        <div class="form-text">4æ¡ã®éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
                    </div>

                    <div class="alert alert-info">
                        <h6><i class="fas fa-lightbulb me-2"></i>LLMäºˆæ¸¬ã®3è¦ç´ </h6>
                        <small>ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‹ã‚‰å–å¾—ã—ãŸ3ã¤ã®äºˆæ¸¬å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</small>
                    </div>

                    <div class="mb-3">
                        <label for="predicted_high" class="form-label">ğŸ“ˆ äºˆæƒ³æœ€é«˜å€¤ (å††)</label>
                        <input type="number" step="0.01" class="form-control" id="predicted_high" 
                               name="predicted_high" placeholder="æœŸé–“ä¸­ã®æœ€é«˜å€¤äºˆæ¸¬" required>
                        <div class="form-text">é€±é–“ã§åˆ°é”ã™ã‚‹ã¨äºˆæƒ³ã•ã‚Œã‚‹æœ€é«˜ä¾¡æ ¼</div>
                    </div>

                    <div class="mb-3">
                        <label for="predicted_low" class="form-label">ğŸ“‰ äºˆæƒ³æœ€å®‰å€¤ (å††)</label>
                        <input type="number" step="0.01" class="form-control" id="predicted_low" 
                               name="predicted_low" placeholder="æœŸé–“ä¸­ã®æœ€å®‰å€¤äºˆæ¸¬" required>
                        <div class="form-text">é€±é–“ã§åˆ°é”ã™ã‚‹ã¨äºˆæƒ³ã•ã‚Œã‚‹æœ€å®‰ä¾¡æ ¼</div>
                    </div>

                    <div class="mb-3">
                        <label for="predicted_close" class="form-label">ğŸ¯ é€±æœ«çµ‚å€¤äºˆæƒ³ (å††)</label>
                        <input type="number" step="0.01" class="form-control" id="predicted_close" 
                               name="predicted_close" placeholder="æœ€çµ‚æ—¥ã®çµ‚å€¤äºˆæ¸¬" required>
                        <div class="form-text">å£²å´æ—¥ã®çµ‚å€¤ã¨ã—ã¦äºˆæƒ³ã•ã‚Œã‚‹ä¾¡æ ¼</div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="buy_date" class="form-label">ğŸ“… è³¼å…¥æ—¥</label>
                        <input type="date" class="form-control" id="buy_date" name="buy_date" required>
                        <div class="form-text">æ ªå¼ã‚’è³¼å…¥ã—ãŸæ—¥ä»˜</div>
                    </div>

                    <div class="mb-3">
                        <label for="sell_date" class="form-label">ğŸ“… å£²å´æ—¥</label>
                        <input type="date" class="form-control" id="sell_date" name="sell_date" required>
                        <div class="form-text">æ ªå¼ã‚’å£²å´ã—ãŸï¼ˆã™ã‚‹äºˆå®šã®ï¼‰æ—¥ä»˜</div>
                    </div>

                    <div class="mb-3">
                        <label for="notes" class="form-label">ğŸ“ å‚™è€ƒ</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3" 
                                  placeholder="LLMã®äºˆæ¸¬æ ¹æ‹ ã‚„ç‰¹è¨˜äº‹é …ãŒã‚ã‚Œã°è¨˜å…¥ã—ã¦ãã ã•ã„"></textarea>
                        <div class="form-text">ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼šè¿½åŠ æƒ…å ±ãŒã‚ã‚Œã°è¨˜å…¥</div>
                    </div>
                </div>
            </div>

            <button type="submit" class="btn btn-primary btn-lg">
                <i class="fas fa-rocket me-2"></i>ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
            </button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // ä»Šæ—¥ã®æ—¥ä»˜ã‚’è¨­å®š
    document.addEventListener('DOMContentLoaded', function() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('buy_date').value = today;
        
        // å£²å´æ—¥ã‚’30æ—¥å¾Œã«è¨­å®š
        const sellDate = new Date();
        sellDate.setDate(sellDate.getDate() + 30);
        document.getElementById('sell_date').value = sellDate.toISOString().split('T')[0];
    });
</script>
{% endblock %}
