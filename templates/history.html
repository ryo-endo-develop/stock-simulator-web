{% extends "base.html" %}

{% block title %}å±¥æ­´åˆ†æ - LLMæŠ•è³‡ã‚¢ã‚¤ãƒ‡ã‚¢æ¤œè¨¼ãƒ„ãƒ¼ãƒ«{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="mb-2">ğŸ“Š å±¥æ­´åˆ†æãƒ»çµ±è¨ˆ</h1>
        <p class="text-muted mb-0">éå»ã®åˆ†æçµæœã‚’çµ±è¨ˆçš„ã«è©•ä¾¡ã—ã€LLMã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’æ¯”è¼ƒã—ã¾ã™ã€‚</p>
    </div>
    <div class="btn-group" role="group">
        <button type="button" class="btn btn-outline-success dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fas fa-download me-2"></i>CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        </button>
        <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="/export/fixed-stock">
                <i class="fas fa-chart-bar me-2"></i>å›ºå®šéŠ˜æŸ„åˆ†æãƒ‡ãƒ¼ã‚¿
            </a></li>
            <li><a class="dropdown-item" href="/export/stock-selection">
                <i class="fas fa-bullseye me-2"></i>éŠ˜æŸ„é¸å®šåˆ†æãƒ‡ãƒ¼ã‚¿
            </a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="/export/all">
                <i class="fas fa-file-csv me-2"></i>å…¨ãƒ‡ãƒ¼ã‚¿çµ±åˆ
            </a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#exportModal">
                <i class="fas fa-filter me-2"></i>é«˜åº¦ãªã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
            </a></li>
        </ul>
    </div>
</div>

<!-- ã‚µãƒãƒªãƒ¼çµ±è¨ˆ -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="card-body text-center">
                <h5 class="card-title">ç·åˆ†æå›æ•°</h5>
                <div class="metric-number">{{ stats.total_analyses }}</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card success-bg">
            <div class="card-body text-center">
                <h5 class="card-title">å…¨ä½“å‹ç‡</h5>
                <div class="metric-number">{{ stats.win_rate }}%</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card info-bg">
            <div class="card-body text-center">
                <h5 class="card-title">å¹³å‡äºˆæ¸¬ç²¾åº¦</h5>
                <div class="metric-number">{{ stats.avg_accuracy }}%</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card danger-bg">
            <div class="card-body text-center">
                <h5 class="card-title">åˆ†æLLMãƒ¢ãƒ‡ãƒ«æ•°</h5>
                <div class="metric-number">{{ stats.unique_models }}</div>
            </div>
        </div>
    </div>
</div>

{% if not fixed_data and not selection_data %}
<div class="alert alert-warning">
    <h6><i class="fas fa-info-circle me-2"></i>åˆ†æå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</h6>
    <p class="mb-0">ã¾ãšä»–ã®ãƒšãƒ¼ã‚¸ã§ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>
</div>
{% else %}

<!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
<ul class="nav nav-tabs" id="historyTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="fixed-tab" data-bs-toggle="tab" data-bs-target="#fixed" 
                type="button" role="tab" aria-controls="fixed" aria-selected="true">
            <i class="fas fa-chart-bar me-2"></i>å›ºå®šéŠ˜æŸ„åˆ†æ ({{ fixed_data|length }}ä»¶)
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="selection-tab" data-bs-toggle="tab" data-bs-target="#selection" 
                type="button" role="tab" aria-controls="selection" aria-selected="false">
            <i class="fas fa-bullseye me-2"></i>éŠ˜æŸ„é¸å®šåˆ†æ ({{ selection_data|length }}ä»¶)
        </button>
    </li>
</ul>

<div class="tab-content mt-4" id="historyTabContent">
    <!-- å›ºå®šéŠ˜æŸ„åˆ†æã‚¿ãƒ– -->
    <div class="tab-pane fade show active" id="fixed" role="tabpanel" aria-labelledby="fixed-tab">
        {% if fixed_data %}
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>å›ºå®šéŠ˜æŸ„åˆ†æå±¥æ­´</h5>
                <a href="/export/fixed-stock" class="btn btn-sm btn-success">
                    <i class="fas fa-download me-1"></i>CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                </a>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>å®Ÿè¡Œæ—¥</th>
                                <th>ãƒ¢ãƒ‡ãƒ«</th>
                                <th>éŠ˜æŸ„</th>
                                <th>è³¼å…¥ä¾¡æ ¼</th>
                                <th>å£²å´ä¾¡æ ¼</th>
                                <th>äºˆæ¸¬ä¾¡æ ¼</th>
                                <th>æç›Š</th>
                                <th>é¨°è½ç‡</th>
                                <th>äºˆæ¸¬ç²¾åº¦</th>
                                <th>æœŸé–“</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in fixed_data %}
                            <tr>
                                <td>{{ item.execution_date.strftime('%Y-%m-%d') if item.execution_date else 'N/A' }}</td>
                                <td><span class="badge bg-primary">{{ item.model_id }}</span></td>
                                <td><strong>{{ item.stock_code }}</strong></td>
                                <td>Â¥{{ "{:,.0f}".format(item.buy_price) }}</td>
                                <td>Â¥{{ "{:,.0f}".format(item.sell_price) }}</td>
                                <td>Â¥{{ "{:,.0f}".format(item.predicted_price) }}</td>
                                <td class="{% if item.profit_loss > 0 %}text-success{% else %}text-danger{% endif %}">
                                    Â¥{{ "{:+,.0f}".format(item.profit_loss) }}
                                </td>
                                <td class="{% if item.return_rate > 0 %}text-success{% else %}text-danger{% endif %}">
                                    {{ "{:+.1f}".format(item.return_rate) }}%
                                </td>
                                <td class="{% if item.prediction_accuracy > 80 %}text-success{% elif item.prediction_accuracy > 60 %}text-warning{% else %}text-danger{% endif %}">
                                    {{ "{:.1f}".format(item.prediction_accuracy) }}%
                                </td>
                                <td>{{ item.period_days }}æ—¥</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% else %}
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>å›ºå®šéŠ˜æŸ„åˆ†æã®å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
        </div>
        {% endif %}
    </div>

    <!-- éŠ˜æŸ„é¸å®šåˆ†æã‚¿ãƒ– -->
    <div class="tab-pane fade" id="selection" role="tabpanel" aria-labelledby="selection-tab">
        {% if selection_data %}
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-bullseye me-2"></i>éŠ˜æŸ„é¸å®šåˆ†æå±¥æ­´</h5>
                <a href="/export/stock-selection" class="btn btn-sm btn-success">
                    <i class="fas fa-download me-1"></i>CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                </a>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>å®Ÿè¡Œæ—¥</th>
                                <th>æœŸé–“</th>
                                <th>ãƒ¢ãƒ‡ãƒ«</th>
                                <th>éŠ˜æŸ„</th>
                                <th>è³¼å…¥ä¾¡æ ¼</th>
                                <th>å£²å´ä¾¡æ ¼</th>
                                <th>æç›Š</th>
                                <th>é¨°è½ç‡</th>
                                <th>é¸å®šç†ç”±</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in selection_data %}
                            <tr>
                                <td>{{ item.execution_date.strftime('%Y-%m-%d') if item.execution_date else 'N/A' }}</td>
                                <td><span class="badge bg-info">{{ item.analysis_period }}</span></td>
                                <td><span class="badge bg-primary">{{ item.model_id }}</span></td>
                                <td><strong>{{ item.stock_code }}</strong></td>
                                <td>Â¥{{ "{:,.0f}".format(item.buy_price) }}</td>
                                <td>Â¥{{ "{:,.0f}".format(item.sell_price) }}</td>
                                <td class="{% if item.profit_loss > 0 %}text-success{% else %}text-danger{% endif %}">
                                    Â¥{{ "{:+,.0f}".format(item.profit_loss) }}
                                </td>
                                <td class="{% if item.return_rate > 0 %}text-success{% else %}text-danger{% endif %}">
                                    {{ "{:+.1f}".format(item.return_rate) }}%
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-secondary" type="button" 
                                            data-bs-toggle="collapse" data-bs-target="#reason-{{ loop.index }}" 
                                            aria-expanded="false">
                                        ç†ç”±ã‚’è¡¨ç¤º
                                    </button>
                                    <div class="collapse mt-2" id="reason-{{ loop.index }}">
                                        <div class="card card-body small">
                                            {{ item.selection_reason }}
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% else %}
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>éŠ˜æŸ„é¸å®šåˆ†æã®å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
        </div>
        {% endif %}
    </div>
</div>

{% endif %}

<!-- é«˜åº¦ãªã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exportModalLabel">
                    <i class="fas fa-filter me-2"></i>é«˜åº¦ãªã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆè¨­å®š
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="exportForm">
                    <div class="row mb-3">
                        <label class="col-sm-3 col-form-label">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¿ã‚¤ãƒ—</label>
                        <div class="col-sm-9">
                            <select class="form-select" id="exportType" name="exportType" required>
                                <option value="fixed-stock">å›ºå®šéŠ˜æŸ„åˆ†æãƒ‡ãƒ¼ã‚¿</option>
                                <option value="stock-selection">éŠ˜æŸ„é¸å®šåˆ†æãƒ‡ãƒ¼ã‚¿</option>
                                <option value="all">å…¨ãƒ‡ãƒ¼ã‚¿çµ±åˆ</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <label class="col-sm-3 col-form-label">LLMãƒ¢ãƒ‡ãƒ«</label>
                        <div class="col-sm-9">
                            <select class="form-select" id="modelId" name="modelId">
                                <option value="">ã™ã¹ã¦</option>
                                {% if stats.unique_models > 0 %}
                                    <option value="gpt-4">GPT-4</option>
                                    <option value="claude-3-opus">Claude 3 Opus</option>
                                    <option value="gemini-pro">Gemini Pro</option>
                                {% endif %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3" id="analysisPeriodsRow" style="display: none;">
                        <label class="col-sm-3 col-form-label">åˆ†ææœŸé–“</label>
                        <div class="col-sm-9">
                            <select class="form-select" id="analysisPeriod" name="analysisPeriod">
                                <option value="">ã™ã¹ã¦</option>
                                <option value="1é€±é–“">1é€±é–“</option>
                                <option value="1ãƒ¶æœˆ">1ãƒ¶æœˆ</option>
                                <option value="3ãƒ¶æœˆ">3ãƒ¶æœˆ</option>
                                <option value="6ãƒ¶æœˆ">6ãƒ¶æœˆ</option>
                                <option value="1å¹´">1å¹´</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <label class="col-sm-3 col-form-label">å®Ÿè¡Œæ—¥æœŸç¯„å›²</label>
                        <div class="col-sm-4">
                            <input type="date" class="form-control" id="startDate" name="startDate" placeholder="é–‹å§‹æ—¥">
                        </div>
                        <div class="col-sm-1 text-center">
                            <span class="col-form-label">ã€œ</span>
                        </div>
                        <div class="col-sm-4">
                            <input type="date" class="form-control" id="endDate" name="endDate" placeholder="çµ‚äº†æ—¥">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <label class="col-sm-3 col-form-label">é¨°è½ç‡ç¯„å›²(%)</label>
                        <div class="col-sm-4">
                            <input type="number" class="form-control" id="minReturn" name="minReturn" 
                                   placeholder="æœ€å°é¨°è½ç‡" step="0.1">
                        </div>
                        <div class="col-sm-1 text-center">
                            <span class="col-form-label">ã€œ</span>
                        </div>
                        <div class="col-sm-4">
                            <input type="number" class="form-control" id="maxReturn" name="maxReturn" 
                                   placeholder="æœ€å¤§é¨°è½ç‡" step="0.1">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" class="btn btn-success" onclick="executeAdvancedExport()">
                    <i class="fas fa-download me-2"></i>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Ÿè¡Œ
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¿ã‚¤ãƒ—ãŒå¤‰ã‚ã£ãŸã¨ãã®å‡¦ç†
document.getElementById('exportType').addEventListener('change', function() {
    const analysisPeriodsRow = document.getElementById('analysisPeriodsRow');
    if (this.value === 'stock-selection') {
        analysisPeriodsRow.style.display = 'block';
    } else {
        analysisPeriodsRow.style.display = 'none';
    }
});

// é«˜åº¦ãªã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Ÿè¡Œ
function executeAdvancedExport() {
    const form = document.getElementById('exportForm');
    const formData = new FormData(form);
    
    const exportType = formData.get('exportType');
    const params = new URLSearchParams();
    
    // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ 
    if (formData.get('modelId')) params.append('model_id', formData.get('modelId'));
    if (formData.get('analysisPeriod') && exportType === 'stock-selection') {
        params.append('analysis_period', formData.get('analysisPeriod'));
    }
    if (formData.get('startDate')) params.append('start_date', formData.get('startDate'));
    if (formData.get('endDate')) params.append('end_date', formData.get('endDate'));
    if (formData.get('minReturn')) params.append('min_return', formData.get('minReturn'));
    if (formData.get('maxReturn')) params.append('max_return', formData.get('maxReturn'));
    
    // URLã‚’ç”Ÿæˆã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    const url = `/export/${exportType}?${params.toString()}`;
    window.open(url, '_blank');
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    const modal = bootstrap.Modal.getInstance(document.getElementById('exportModal'));
    modal.hide();
}
</script>

{% endblock %}
