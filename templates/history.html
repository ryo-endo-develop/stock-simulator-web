{% extends "base.html" %}

{% block title %}å±¥æ­´åˆ†æ - LLMæŠ•è³‡ã‚¢ã‚¤ãƒ‡ã‚¢æ¤œè¨¼ãƒ„ãƒ¼ãƒ«{% endblock %}

{% block content %}
<h1 class="mb-4">ğŸ“Š å±¥æ­´åˆ†æãƒ»çµ±è¨ˆ</h1>
<p class="text-muted mb-4">éå»ã®åˆ†æçµæœã‚’çµ±è¨ˆçš„ã«è©•ä¾¡ã—ã€LLMã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’æ¯”è¼ƒã—ã¾ã™ã€‚</p>

<!-- ã‚µãƒãƒªãƒ¼çµ±è¨ˆ -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="card-body text-center">
                <h5 class="card-title">ç·åˆ†æå›æ•°</h5>
                <div class="metric-number">{{ stats.total_analyses }}</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card success-bg">
            <div class="card-body text-center">
                <h5 class="card-title">å…¨ä½“å‹ç‡</h5>
                <div class="metric-number">{{ stats.win_rate }}%</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card info-bg">
            <div class="card-body text-center">
                <h5 class="card-title">å¹³å‡äºˆæ¸¬ç²¾åº¦</h5>
                <div class="metric-number">{{ stats.avg_accuracy }}%</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card danger-bg">
            <div class="card-body text-center">
                <h5 class="card-title">åˆ†æLLMãƒ¢ãƒ‡ãƒ«æ•°</h5>
                <div class="metric-number">{{ stats.unique_models }}</div>
            </div>
        </div>
    </div>
</div>

{% if not fixed_data and not selection_data %}
<div class="alert alert-warning">
    <h6><i class="fas fa-info-circle me-2"></i>åˆ†æå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</h6>
    <p class="mb-0">ã¾ãšä»–ã®ãƒšãƒ¼ã‚¸ã§ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>
</div>
{% else %}

<!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
<ul class="nav nav-tabs" id="historyTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="fixed-tab" data-bs-toggle="tab" data-bs-target="#fixed" 
                type="button" role="tab" aria-controls="fixed" aria-selected="true">
            <i class="fas fa-chart-bar me-2"></i>å›ºå®šéŠ˜æŸ„åˆ†æ ({{ fixed_data|length }}ä»¶)
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="selection-tab" data-bs-toggle="tab" data-bs-target="#selection" 
                type="button" role="tab" aria-controls="selection" aria-selected="false">
            <i class="fas fa-bullseye me-2"></i>éŠ˜æŸ„é¸å®šåˆ†æ ({{ selection_data|length }}ä»¶)
        </button>
    </li>
</ul>

<div class="tab-content mt-4" id="historyTabContent">
    <!-- å›ºå®šéŠ˜æŸ„åˆ†æã‚¿ãƒ– -->
    <div class="tab-pane fade show active" id="fixed" role="tabpanel" aria-labelledby="fixed-tab">
        {% if fixed_data %}
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>å›ºå®šéŠ˜æŸ„åˆ†æå±¥æ­´</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>å®Ÿè¡Œæ—¥</th>
                                <th>ãƒ¢ãƒ‡ãƒ«</th>
                                <th>éŠ˜æŸ„</th>
                                <th>è³¼å…¥ä¾¡æ ¼</th>
                                <th>å£²å´ä¾¡æ ¼</th>
                                <th>äºˆæ¸¬ä¾¡æ ¼</th>
                                <th>æç›Š</th>
                                <th>é¨°è½ç‡</th>
                                <th>äºˆæ¸¬ç²¾åº¦</th>
                                <th>æœŸé–“</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in fixed_data %}
                            <tr>
                                <td>{{ item.execution_date.strftime('%Y-%m-%d') if item.execution_date else 'N/A' }}</td>
                                <td><span class="badge bg-primary">{{ item.model_id }}</span></td>
                                <td><strong>{{ item.stock_code }}</strong></td>
                                <td>Â¥{{ "{:,.0f}".format(item.buy_price) }}</td>
                                <td>Â¥{{ "{:,.0f}".format(item.sell_price) }}</td>
                                <td>Â¥{{ "{:,.0f}".format(item.predicted_price) }}</td>
                                <td class="{% if item.profit_loss > 0 %}text-success{% else %}text-danger{% endif %}">
                                    Â¥{{ "{:+,.0f}".format(item.profit_loss) }}
                                </td>
                                <td class="{% if item.return_rate > 0 %}text-success{% else %}text-danger{% endif %}">
                                    {{ "{:+.1f}".format(item.return_rate) }}%
                                </td>
                                <td class="{% if item.prediction_accuracy > 80 %}text-success{% elif item.prediction_accuracy > 60 %}text-warning{% else %}text-danger{% endif %}">
                                    {{ "{:.1f}".format(item.prediction_accuracy) }}%
                                </td>
                                <td>{{ item.period_days }}æ—¥</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% else %}
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>å›ºå®šéŠ˜æŸ„åˆ†æã®å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
        </div>
        {% endif %}
    </div>

    <!-- éŠ˜æŸ„é¸å®šåˆ†æã‚¿ãƒ– -->
    <div class="tab-pane fade" id="selection" role="tabpanel" aria-labelledby="selection-tab">
        {% if selection_data %}
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-bullseye me-2"></i>éŠ˜æŸ„é¸å®šåˆ†æå±¥æ­´</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>å®Ÿè¡Œæ—¥</th>
                                <th>æœŸé–“</th>
                                <th>ãƒ¢ãƒ‡ãƒ«</th>
                                <th>éŠ˜æŸ„</th>
                                <th>è³¼å…¥ä¾¡æ ¼</th>
                                <th>å£²å´ä¾¡æ ¼</th>
                                <th>æç›Š</th>
                                <th>é¨°è½ç‡</th>
                                <th>é¸å®šç†ç”±</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in selection_data %}
                            <tr>
                                <td>{{ item.execution_date.strftime('%Y-%m-%d') if item.execution_date else 'N/A' }}</td>
                                <td><span class="badge bg-info">{{ item.analysis_period }}</span></td>
                                <td><span class="badge bg-primary">{{ item.model_id }}</span></td>
                                <td><strong>{{ item.stock_code }}</strong></td>
                                <td>Â¥{{ "{:,.0f}".format(item.buy_price) }}</td>
                                <td>Â¥{{ "{:,.0f}".format(item.sell_price) }}</td>
                                <td class="{% if item.profit_loss > 0 %}text-success{% else %}text-danger{% endif %}">
                                    Â¥{{ "{:+,.0f}".format(item.profit_loss) }}
                                </td>
                                <td class="{% if item.return_rate > 0 %}text-success{% else %}text-danger{% endif %}">
                                    {{ "{:+.1f}".format(item.return_rate) }}%
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-secondary" type="button" 
                                            data-bs-toggle="collapse" data-bs-target="#reason-{{ loop.index }}" 
                                            aria-expanded="false">
                                        ç†ç”±ã‚’è¡¨ç¤º
                                    </button>
                                    <div class="collapse mt-2" id="reason-{{ loop.index }}">
                                        <div class="card card-body small">
                                            {{ item.selection_reason }}
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% else %}
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>éŠ˜æŸ„é¸å®šåˆ†æã®å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
        </div>
        {% endif %}
    </div>
</div>

{% endif %}
{% endblock %}
